<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Traffic Analysis System Pro</title>
    <style>
        :root {
            --primary: #4f46e5;
            --danger: #ef4444;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --sidebar-width: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); padding: 20px; }

        .workspace {
            display: flex;
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            height: 80vh;
            border: 1px solid #334155;
        }

        /* Sidebar tool icons */
        .sidebar {
            width: var(--sidebar-width);
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            gap: 12px;
            border-right: 1px solid #334155;
        }

        .tool-group-label {
            color: #64748b;
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 800;
            margin-top: 10px;
        }

        .tool-btn {
            width: 42px; height: 42px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: none; background: transparent;
            color: #94a3b8; cursor: pointer; transition: 0.2s;
        }

        .tool-btn svg { width: 22px; height: 22px; fill: currentColor; }
        .tool-btn:hover { background: #334155; color: white; }
        .tool-btn.active { background: var(--primary); color: white; }
        .tool-btn.btn-danger:hover { background: var(--danger); color: white; }

        .canvas-area { flex-grow: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        
        .workspace-header {
            background: #1e293b;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            color: #cbd5e1;
            font-size: 13px;
            border-bottom: 1px solid #334155;
        }

        #canvas-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { cursor: crosshair; }

        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        button.main-btn { padding: 12px 24px; border-radius: 8px; border: none; background: var(--primary); color: white; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div class="workspace">
        <div class="sidebar">
            <div class="tool-group-label">Poly</div>
            <button class="tool-btn active" id="tool-poly-free" onclick="setTool('poly-free')" title="Free Polygon">
                <svg viewBox="0 0 24 24"><path d="M17,15.7L22,12.9V11L17,8.2L12,11V12.9L17,15.7M17,19L10,15.1V16.4L17,20.3L24,16.4V15.1L17,19M17,2L0,11.5V13.5L17,23L24,19V17L17,21L2,12.5L17,4.1L32,12.5V13.5L30,14.6V12.5L17,2Z" /></svg>
            </button>
            <button class="tool-btn" id="tool-poly-rect" onclick="setTool('poly-rect')" title="Rectangle">
                <svg viewBox="0 0 24 24"><path d="M19,3H5C3.89,3 3,3.89 3,5V19C3,20.1 3.89,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19Z" /></svg>
            </button>
            <button class="tool-btn" id="tool-poly-circle" onclick="setTool('poly-circle')" title="Circle">
                <svg viewBox="0 0 24 24"><path d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>
            </button>
            <button class="tool-btn" id="tool-poly-star" onclick="setTool('poly-star')" title="Star">
                <svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" /></svg>
            </button>

            <div class="tool-group-label">Line</div>
            <button class="tool-btn" id="tool-line-multi" onclick="setTool('line-multi')" title="Multi-point Line">
                <svg viewBox="0 0 24 24"><path d="M3.5,18.5L9.5,12.5L13.5,16.5L22,6.91L20.59,5.5L13.5,13.67L9.5,9.67L2,17.17L3.5,18.5Z" /></svg>
            </button>
            <button class="tool-btn" id="tool-line-arch" onclick="setTool('line-arch')" title="Arch Line">
                <svg viewBox="0 0 24 24"><path d="M14,3C12.3,3 10.7,3.5 9.3,4.4C8,5.3 7,6.6 6.4,8H8.5C9,7.1 9.8,6.4 10.8,5.9C11.8,5.4 12.9,5.2 14,5.2C17.9,5.2 21,8.3 21,12.2V14H23V12.2C23,7.1 18.9,3 14,3M3,12V21H12V19H5V12H3Z" /></svg>
            </button>
            <button class="tool-btn" id="tool-line-wiggle" onclick="setTool('line-wiggle')" title="Wiggle Line">
                <svg viewBox="0 0 24 24"><path d="M22,12C22,12 21,11 19,11C17,11 16,12 16,12C16,12 15,13 13,13C11,13 10,12 10,12C10,12 9,11 7,11C5,11 4,12 4,12C4,12 3,13 1,13V11C1,11 2,10 4,10C6,10 7,11 7,11C7,11 8,12 10,12C12,12 13,11 13,11C13,11 14,10 16,10C18,10 19,11 19,11C19,11 20,12 22,12Z" /></svg>
            </button>

            <div style="flex-grow: 1;"></div>
            
            <button class="tool-btn btn-danger" onclick="deleteSelected()" title="Delete Selected Shape">
                <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
            </button>
        </div>

        <div class="canvas-area">
            <div class="workspace-header">
                <div id="status-text">Select a tool to begin. (Right-click to finish lines/polygons)</div>
                <div id="selection-label" style="font-weight: bold; color: #818cf8;">Nothing Selected</div>
            </div>
            <div id="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="main-btn" onclick="exportData()">Process AI Analysis</button>
    </div>

    <script>
        let canvas, ctx, bgImg;
        let shapes = [];
        let currentShape = null;
        let selectedShape = null;
        let selectedTool = 'poly-free';

        // Dragging state
        let isDragging = false;
        let dragTarget = null; // { shapeIndex, pointIndex }
        const POINT_HIT_RADIUS = 10;

        window.onload = () => {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            canvas.width = 1000;
            canvas.height = 600;

            // Load a dummy background (Replace with your uploaded image)
            bgImg = new Image();
            bgImg.src = "https://images.unsplash.com/photo-1545147480-7f3909faa1ad?auto=format&fit=crop&w=1000&q=80";
            bgImg.onload = redraw;

            // Events
            canvas.addEventListener('mousedown', onMouseDown);
            canvas.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', () => { isDragging = false; dragTarget = null; });
            canvas.addEventListener('contextmenu', (e) => { e.preventDefault(); finishCurrentShape(); });
            window.addEventListener('keydown', (e) => { if(e.key === "Delete" || e.key === "Backspace") deleteSelected(); });
        };

        function setTool(tool) {
            selectedTool = tool;
            currentShape = null;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tool-' + tool).classList.add('active');
            document.getElementById('status-text').textContent = `Mode: ${tool.replace('-', ' ')}. Click to draw.`;
        }

        function onMouseDown(e) {
            const pos = getMousePos(e);
            
            // 1. Try to select a point for dragging
            const hit = findHit(pos);
            if (hit) {
                isDragging = true;
                dragTarget = hit;
                selectedShape = shapes[hit.shapeIndex];
                updateSelectionLabel();
                redraw();
                return;
            }

            // 2. Start drawing if no point hit
            if (!currentShape) {
                if (selectedTool === 'poly-free' || selectedTool === 'line-multi') {
                    currentShape = { 
                        type: selectedTool.startsWith('poly') ? 'polygon' : 'line',
                        points: [pos],
                        color: selectedTool.startsWith('poly') ? '#4f46e5' : '#fbbf24'
                    };
                    shapes.push(currentShape);
                    selectedShape = currentShape;
                } else {
                    createPrimitive(selectedTool, pos);
                }
            } else {
                currentShape.points.push(pos);
            }
            updateSelectionLabel();
            redraw();
        }

        function createPrimitive(type, pos) {
            let points = [];
            let color = type.startsWith('poly') ? '#4f46e5' : '#fbbf24';
            let shapeType = type.startsWith('poly') ? 'polygon' : 'line';

            if (type === 'poly-rect') {
                points = [
                    {x: pos.x, y: pos.y}, {x: pos.x + 120, y: pos.y},
                    {x: pos.x + 120, y: pos.y + 80}, {x: pos.x, y: pos.y + 80}
                ];
            } else if (type === 'poly-circle') {
                for (let i = 0; i < 8; i++) {
                    let a = (i / 8) * Math.PI * 2;
                    points.push({x: pos.x + Math.cos(a)*50, y: pos.y + Math.sin(a)*50});
                }
            } else if (type === 'poly-star') {
                for (let i = 0; i < 10; i++) {
                    let a = (i / 10) * Math.PI * 2;
                    let r = i % 2 === 0 ? 50 : 20;
                    points.push({x: pos.x + Math.cos(a)*r, y: pos.y + Math.sin(a)*r});
                }
            } else if (type === 'line-arch') {
                points = [{x: pos.x, y: pos.y}, {x: pos.x+50, y: pos.y-40}, {x: pos.x+100, y: pos.y}];
            } else if (type === 'line-wiggle') {
                points = [{x: pos.x, y: pos.y}, {x: pos.x+30, y: pos.y-30}, {x: pos.x+60, y: pos.y+30}, {x: pos.x+90, y: pos.y}];
            }

            let newShape = { type: shapeType, points, color, isClosed: shapeType === 'polygon' };
            shapes.push(newShape);
            selectedShape = newShape;
        }

        function onMouseMove(e) {
            const pos = getMousePos(e);
            if (isDragging && dragTarget) {
                shapes[dragTarget.shapeIndex].points[dragTarget.pointIndex] = pos;
                redraw();
            }
        }

        function finishCurrentShape() {
            if (currentShape) {
                if (currentShape.type === 'polygon') currentShape.isClosed = true;
                currentShape = null;
                redraw();
            }
        }

        function deleteSelected() {
            if (selectedShape) {
                shapes = shapes.filter(s => s !== selectedShape);
                selectedShape = null;
                currentShape = null;
                updateSelectionLabel();
                redraw();
            }
        }

        function updateSelectionLabel() {
            const el = document.getElementById('selection-label');
            if (selectedShape) {
                el.textContent = `Selected: ${selectedShape.type.toUpperCase()}`;
            } else {
                el.textContent = "Nothing Selected";
            }
        }

        function findHit(pos) {
            for (let sIdx = shapes.length - 1; sIdx >= 0; sIdx--) {
                const pts = shapes[sIdx].points;
                for (let pIdx = 0; pIdx < pts.length; pIdx++) {
                    if (Math.hypot(pts[pIdx].x - pos.x, pts[pIdx].y - pos.y) < POINT_HIT_RADIUS) {
                        return { shapeIndex: sIdx, pointIndex: pIdx };
                    }
                }
            }
            return null;
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (bgImg) ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

            shapes.forEach(shape => {
                const isSel = (shape === selectedShape);
                ctx.beginPath();
                ctx.lineWidth = isSel ? 4 : 2;
                ctx.strokeStyle = shape.color;
                ctx.setLineDash(isSel ? [5, 5] : []);

                ctx.moveTo(shape.points[0].x, shape.points[0].y);
                shape.points.forEach(p => ctx.lineTo(p.x, p.y));

                if (shape.isClosed) {
                    ctx.closePath();
                    ctx.fillStyle = shape.color + "33";
                    ctx.fill();
                }
                ctx.stroke();

                // Draw vertices
                ctx.setLineDash([]);
                shape.points.forEach(p => {
                    ctx.fillStyle = isSel ? "#fff" : shape.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, isSel ? 6 : 4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
            });
        }

        function exportData() {
            console.log("Shapes Data:", JSON.stringify(shapes));
            alert("Sent " + shapes.length + " geometries to AI Engine.");
        }
    </script>
</body>
</html>